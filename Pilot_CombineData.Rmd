---
title: "Determining Cognitive Load difficulty - Pilot Analysis"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

This is a short script that combines the pilot data files and saves a CSV that you can plot with.

## Loading the Data 

First, we want to add the files into one big data frame. For each participant we have two files. One 'EndofTrial' file that records counts, and one 'WithinTrial' file that records responses to stimuli.


```{r, echo=TRUE, message=FALSE}

library("tidyverse") #load code libraries for analysis

FilePath <- "~/SP_18-19/Pilot_Data/" #filepath (~ means to look in user's working directory)
Exp_ID <- "Orca18_Pilot_" #experiment code that gets prepended to any data file.
EoT <- "_EndofTrial.csv" #text at end of EndofTrial files
WiT <- "_WithinTrial.csv" #text at end of WithinTrial files
PPs <- 1:3 #vector of participant codes

for (pp in PPs){ #this for loop will loop through our participant vector
  filename_EoT = paste(FilePath,Exp_ID, pp, EoT, sep="") #creates a string from our variables
  filename_WiT = paste(FilePath,Exp_ID, pp, WiT, sep="") #creates a string from our variables
  
  if (pp == 1){ #if it is the first participant, create a new data frame.
    
    EoT_dataframe <- read.csv(filename_EoT) #load data
    WiT_dataframe <- read.csv(filename_WiT)
    
  } else{ #if it isn't the first participant, add loaded files to existing data frame
    EoT_newdata <- read.csv(filename_EoT) #load data
    WiT_newdata <- read.csv(filename_WiT)
    
    EoT_dataframe <- rbind(EoT_newdata, EoT_dataframe) #add to existing datframe  
    WiT_dataframe <- rbind(WiT_newdata, WiT_dataframe) #add to existing datframe 
  }
}

head(EoT_dataframe) #view start of dataframe.
head(WiT_dataframe) #view start of dataframe.

```

You can see that we have two data frames. 

The first, __EoT_dataframe__ has 12 columns. Each row is a trial (_trialn_) . The first column _X_ is the data frame index so each row has a unique identifier. The next four columns (_ppid, targetoccurence, targetnumber, trialn_) contains all the information necessary for that particular trial. The last three rows (_EoTScore1, TargetCount1...EoTScore3, TargetCount3_) contains the user inputted scores, and the actual target counts for each target. NA is inputted to any cells of trials that had fewer targets than three. 

The second dataframe, __WiT_dataframe__, also has 12 columns. Here each row is a stimulus presentation. The first five columns are the same as __EoT_dataframe__. _CurrentAudio_ is the heard stimulus. _RT_ is the response time (-1 if not responded). _ResponseCategory_ is a code for how appropriate the response is: 1 = true positive, 2 = false negative, 3 = false positive, 4 =  true negative. _Target1...Target3_ indicates the actual targets for that trial. 

Let's save these files so we don't have to load them again.
```{r}
write.csv(EoT_dataframe, "Pilot_Data/Orca18_Pilot_EndofTrial_ALLPPs.csv")
write.csv(WiT_dataframe, "Pilot_Data/Orca18_Pilot_WithinTrial_ALLPPs.csv")
```


## Calculating Measures

The dataframes now hold all the data needed for calculating measures for each trial.

The experiment design allows many ways to capture performance. There are three obvious ways of measures performance: the speed of response, whether the participant responded appropriately, and how far off they were in their recorded target counts.

From the __WiT_dataframe__ the following measures need to be calculated:   
1. MeanRT_TruePos (MeanRT for True Positives)   
2. StdRT_TruePos (Standard deviation of RT for True Positives)   
3. Perc_Correct (True Positives and True Negatives)   

First, we want to remove any RTs that are unfeasibly quick, since they are probably responding to the previously head stimuli. Based on Luce (1986), this value is set at 100ms.

```{r}
WiT_RTfiltered <- filter(WiT_dataframe, RT == -1 | RT >.1) # Returns dataframe for rows where RT was >.1 or -1 (no response) 
```

To calculate the RT measures, only the True Positives should be selected. In R, using the _tidyverse piping syntax_ (https://style.tidyverse.org/pipes.html), we can use _group_by()_ and _summarise()_ to calculate the mean and standard deviation of a particular trial's RTs.

```{r}
  
WiT_TruePos <- filter(WiT_RTfiltered, ResponseCategory == 1) #create new dataframe only including true positives
  
SummaryRTs <- WiT_TruePos %>% group_by(ppid, trialn) %>% summarise(meanRT = mean(RT),
                                                                         stdRT = sd(RT)) 
head(SummaryRTs) #view start of dataframe. For every participant and trial there will be a meanRT and a stdRT. stdRT is sometimes NA when there is only one True Positive for that trial. The trial will be missing if there are no True Positives for that trial. 

```

All the response categories are needed for calculating Perc_Correct, not just the True Positives.

```{r}

#Calculate the amount of each type of responses
SummaryCounts <- WiT_RTfiltered %>% group_by(ppid, trialn) %>% summarise(
  TruePos = sum(ResponseCategory==1),
  FalseNeg = sum(ResponseCategory==2), 
  FalsePos = sum(ResponseCategory==3),
  TrueNeg = sum(ResponseCategory==4), 
  TotalResponses=n())

#add an extra column with Perc_Correct.
SummaryCounts <- mutate(SummaryCounts, Perc_Correct = (TruePos + TrueNeg)/ TotalResponses)
```

Now all the measures have been calculated for each trial, the dataframes can be and saved.

```{r}

#merges dataframes.
SummaryMeasures <- merge(SummaryCounts, SummaryRTs, by = c("ppid","trialn"), all.x = TRUE)

head(SummaryMeasures)

write.csv(SummaryMeasures, "Orca18_Pilot_SummaryTrialMeasures.csv")
```

You can either load up SummaryTrialMeasures.csv into excel. Or continue reading for an example of how to plot things in R.